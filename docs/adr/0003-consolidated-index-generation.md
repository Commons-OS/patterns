# ADR-0003: Consolidated Index Generation Script

**Status:** Accepted

**Date:** 2026-02-02

**Deciders:** Commons OS maintainers

## Context

The Pattern Engine generates several JSON index files to support search, relationship queries, and entity lookups. Originally, these were generated by separate scripts:

| Script | Output | Purpose |
|--------|--------|---------|
| `generate_pattern_index.py` | `pattern_index.json` | Pattern metadata index |
| `generate_search_index.py` | `search-index.json` | Frontend search |
| `build_graph.py` | `graph.json` | Knowledge graph with relationships |

This approach had several problems:

1. **Redundant file parsing**: Each script independently read and parsed all 1,000+ pattern files
2. **Inconsistent outputs**: Scripts could produce inconsistent data if run at different times
3. **Maintenance burden**: Changes to pattern format required updating multiple scripts
4. **Confusion**: Contributors didn't know which script to run

## Decision

Consolidate all index generation into a single script: `scripts/build_indexes.py`

This script:
1. Reads all pattern files once
2. Generates all indexes in a single pass
3. Outputs:
   - `search-index.json` — Frontend search (title, summary, URL)
   - `data/graph.json` — Knowledge graph (nodes, edges, relationships)
   - `_data/registry.json` — TypeID to pattern mapping

The old scripts were deleted:
- `generate_pattern_index.py` (deleted)
- `generate_search_index.py` (deleted)
- `build_graph.py` (deleted)

GitHub Actions workflows were updated to call `build_indexes.py` instead of the individual scripts.

## Consequences

### Positive

- **Single source of truth**: One script handles all index generation
- **Consistency**: All indexes are generated from the same file parse
- **Performance**: Patterns are read once instead of multiple times
- **Simplicity**: Contributors only need to know one script
- **Easier maintenance**: Changes to pattern format only require updating one script

### Negative

- **Larger script**: `build_indexes.py` is more complex than individual scripts
- **All-or-nothing**: Cannot regenerate just one index without the others

### Neutral

- Output file locations remain the same for backward compatibility
- GitHub Actions trigger the script on push to main branch

## Alternatives Considered

### Alternative 1: Keep Separate Scripts with Shared Parser

Create a shared pattern parser module used by all scripts.

**Rejected because:**
- Still requires running multiple scripts
- More complex module structure
- Doesn't solve the consistency problem if scripts are run separately

### Alternative 2: Database-Backed Indexes

Store parsed patterns in SQLite, generate indexes from database.

**Rejected because:**
- Adds database dependency
- Overkill for current scale
- Conflicts with file-based architecture decision (see system ADR-0002)

## References

- System-wide ADR-0002: File-Based Architecture with Derived Indexes
- `scripts/build_indexes.py` for implementation
- `.github/workflows/generate-pattern-index.yml` for automation
